<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ raport.nazwa }} - Baza Pracowników</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .nav-link-header {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            margin: 0 10px;
        }
        
        .nav-link-header:hover {
            color: white;
            text-decoration: underline;
        }
        
        .report-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .stats-card.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-card.success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .stats-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .stats-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .employee-row {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            transition: background-color 0.3s ease;
        }
        
        .employee-row:hover {
            background: #e9ecef;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background-color: rgba(255,255,255,0.3);
        }
        
        .progress-bar-custom {
            border-radius: 4px;
        }
        
        .report-meta {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }
        
        @media print {
            .no-print { 
                display: none; 
            }
            body { 
                background: white; 
            }
            .report-container, .chart-container, .stats-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="header no-print">
        <div class="container">
            <div class="text-center">
                <h1><i class="fas fa-file-alt"></i> {{ raport.nazwa }}</h1>
                <p class="mb-3">Szczegółowy raport analityczny</p>
                <div class="navigation">
                    <a href="{% url 'analityka_dashboard' %}" class="nav-link-header">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <a href="{% url 'generuj_raport' %}" class="nav-link-header">
                        <i class="fas fa-plus"></i> Nowy raport
                    </a>
                    <a href="{% url 'lista_pracownikow' %}" class="nav-link-header">
                        <i class="fas fa-users"></i> Pracownicy
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Metadane raportu -->
        <div class="report-meta">
            <div class="row">
                <div class="col-md-3">
                    <strong>Typ raportu:</strong><br>
                    <span class="badge bg-primary">{{ raport.get_typ_display }}</span>
                </div>
                <div class="col-md-3">
                    <strong>Status:</strong><br>
                    {% if raport.status == 'gotowy' %}
                        <span class="badge bg-success">{{ raport.get_status_display }}</span>
                    {% else %}
                        <span class="badge bg-warning">{{ raport.get_status_display }}</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>Period:</strong><br>
                    {{ raport.data_od }} - {{ raport.data_do }}
                </div>
                <div class="col-md-3">
                    <strong>Utworzony:</strong><br>
                    {{ raport.data_utworzenia|date:"d.m.Y H:i" }}
                    <br><small>przez {{ raport.utworzony_przez.imie }} {{ raport.utworzony_przez.nazwisko }}</small>
                </div>
            </div>
        </div>

        <!-- Akcje -->
        <div class="text-center mb-4 no-print">
            <button onclick="window.print()" class="btn btn-outline-primary me-2">
                <i class="fas fa-print"></i> Drukuj
            </button>
            <button onclick="exportToPDF()" class="btn btn-outline-success me-2">
                <i class="fas fa-file-pdf"></i> Eksportuj PDF
            </button>
            <button onclick="shareReport()" class="btn btn-outline-info">
                <i class="fas fa-share"></i> Udostępnij
            </button>
        </div>

        {% if raport.dane_json %}
            <!-- Podsumowanie -->
            {% if raport.dane_json.podsumowanie %}
            <div class="report-container">
                <h3><i class="fas fa-chart-bar text-primary"></i> Podsumowanie wykonawcze</h3>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stats-card primary text-center">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <h4>{{ raport.dane_json.podsumowanie.liczba_pracowników }}</h4>
                            <p class="mb-0">Pracowników</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card success text-center">
                            <i class="fas fa-star fa-2x mb-2"></i>
                            <h4>{{ raport.dane_json.podsumowanie.średnia_ocen|floatformat:2 }}</h4>
                            <p class="mb-0">Średnia ocen</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card warning text-center">
                            <i class="fas fa-tasks fa-2x mb-2"></i>
                            <h4>{{ raport.dane_json.podsumowanie.liczba_zadań }}</h4>
                            <p class="mb-0">Zadań</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card info text-center">
                            <i class="fas fa-percentage fa-2x mb-2"></i>
                            <h4>{{ raport.dane_json.podsumowanie.procent_ukończonych|floatformat:1 }}%</h4>
                            <p class="mb-0">Ukończonych</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Top pracownicy -->
            {% if raport.dane_json.top_pracownicy %}
            <div class="chart-container">
                <h4><i class="fas fa-trophy text-warning"></i> Top pracownicy w okresie raportowania</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Pozycja</th>
                                <th>Pracownik</th>
                                <th>Zespół</th>
                                <th>Średnia ocen</th>
                                <th>Liczba ocen</th>
                                <th>Wykonanych zadań</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pracownik in raport.dane_json.top_pracownicy %}
                            <tr>
                                <td>
                                    <strong class="text-primary">#{{ forloop.counter }}</strong>
                                    {% if forloop.counter == 1 %}🥇
                                    {% elif forloop.counter == 2 %}🥈
                                    {% elif forloop.counter == 3 %}🥉
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ pracownik.imie }} {{ pracownik.nazwisko }}</strong>
                                    <br><small class="text-muted">{{ pracownik.stanowisko }}</small>
                                </td>
                                <td>{{ pracownik.zespol|default:"-" }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ pracownik.średnia_ocen|floatformat:1 }}/5</span>
                                        <div class="progress progress-custom" style="width: 60px;">
                                            <div class="progress-bar progress-bar-custom bg-warning" 
                                                 style="width: {{ pracownik.średnia_ocen|floatformat:0 }}0%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ pracownik.liczba_ocen }}</td>
                                <td>
                                    <span class="badge bg-success">{{ pracownik.wykonane_zadania|default:0 }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Analiza zadań -->
            {% if raport.dane_json.zadania_stats %}
            <div class="chart-container">
                <h4><i class="fas fa-tasks text-info"></i> Analiza zadań</h4>
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="tasksChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <h6>Statystyki zadań:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Nowe:</strong> {{ raport.dane_json.zadania_stats.nowe|default:0 }}</li>
                            <li><strong>W trakcie:</strong> {{ raport.dane_json.zadania_stats.w_trakcie|default:0 }}</li>
                            <li><strong>Ukończone:</strong> {{ raport.dane_json.zadania_stats.ukonczone|default:0 }}</li>
                            <li><strong>Anulowane:</strong> {{ raport.dane_json.zadania_stats.anulowane|default:0 }}</li>
                        </ul>
                        {% if raport.dane_json.zadania_stats.procent_ukończonych %}
                        <div class="mt-3">
                            <p class="mb-1">Procent ukończonych:</p>
                            <div class="progress">
                                <div class="progress-bar bg-success" 
                                     style="width: {{ raport.dane_json.zadania_stats.procent_ukończonych }}%">
                                    {{ raport.dane_json.zadania_stats.procent_ukończonych|floatformat:1 }}%
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Analiza zespołów -->
            {% if raport.dane_json.zespoly_stats %}
            <div class="chart-container">
                <h4><i class="fas fa-users text-success"></i> Analiza zespołów</h4>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Zespół</th>
                                <th>Liczba pracowników</th>
                                <th>Średnia ocen</th>
                                <th>Zadania wykonane</th>
                                <th>Efektywność</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for zespol in raport.dane_json.zespoly_stats %}
                            <tr>
                                <td><strong>{{ zespol.nazwa }}</strong></td>
                                <td>{{ zespol.liczba_pracowników }}</td>
                                <td>{{ zespol.średnia_ocen|floatformat:2 }}/5</td>
                                <td>{{ zespol.zadania_wykonane|default:0 }}</td>
                                <td>
                                    {% if zespol.efektywność >= 80 %}
                                        <span class="badge bg-success">Wysoka</span>
                                    {% elif zespol.efektywność >= 60 %}
                                        <span class="badge bg-warning">Średnia</span>
                                    {% else %}
                                        <span class="badge bg-danger">Niska</span>
                                    {% endif %}
                                    ({{ zespol.efektywność|floatformat:0 }}%)
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

        {% else %}
            <div class="report-container text-center">
                <div class="mb-4">
                    {% if raport.status == 'generowanie' %}
                        <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                        <h4>Raport jest generowany...</h4>
                        <p class="text-muted">Proszę odświeżyć stronę za chwilę.</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-refresh"></i> Odśwież
                        </button>
                    {% elif raport.status == 'błąd' %}
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h4>Wystąpił błąd podczas generowania raportu</h4>
                        <p class="text-muted">Spróbuj wygenerować raport ponownie.</p>
                    {% else %}
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h4>Brak danych raportu</h4>
                        <p class="text-muted">Raport nie zawiera jeszcze żadnych danych.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Stopka raportu -->
        <div class="report-container mt-4">
            <div class="text-center text-muted">
                <small>
                    Raport wygenerowany {{ raport.data_utworzenia|date:"d.m.Y o H:i" }} 
                    przez system Baza Pracowników<br>
                    {% if raport.opis %}{{ raport.opis }}{% endif %}
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wykres zadań
        {% if raport.dane_json.zadania_stats %}
        const ctx = document.getElementById('tasksChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Nowe', 'W trakcie', 'Ukończone', 'Anulowane'],
                    datasets: [{
                        data: [
                            {{ raport.dane_json.zadania_stats.nowe|default:0 }},
                            {{ raport.dane_json.zadania_stats.w_trakcie|default:0 }},
                            {{ raport.dane_json.zadania_stats.ukonczone|default:0 }},
                            {{ raport.dane_json.zadania_stats.anulowane|default:0 }}
                        ],
                        backgroundColor: [
                            '#ffc107',
                            '#17a2b8', 
                            '#28a745',
                            '#dc3545'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        {% endif %}
        
        function exportToPDF() {
            alert('Funkcja eksportu PDF będzie wkrótce dostępna!');
        }
        
        function shareReport() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link do raportu został skopiowany do schowka!');
            });
        }
        
        // Auto-refresh dla raportów w trakcie generowania
        {% if raport.status == 'generowanie' %}
        setTimeout(() => {
            location.reload();
        }, 30000); // Odśwież po 30 sekundach
        {% endif %}
    </script>
</body>
</html>
